/*!
 * csv_morningtrain
 * Copyright(c) 2018 Lijo E John
 * MIT Licensed
 */

'use strict'

/**
 * Module dependencies.
 * @private
 */

var formidable = require('formidable'),
fs = require('fs');

/**
 * Module exports.
 * @public
 */
 
/**
 * @name parsecsv
 * @summary Function to parse the csv.
 * @param {object} req
 * @param {object} res
 * @returns {object} csv data
 * @version    1.0
 * @author     Lijo E John <lijoejohn@gmail.com>
 */
exports.parsecsv = function (req,res){
	//Accept the form data
	var form = new formidable.IncomingForm();
	form.parse(req, function(err, fields, files)
	{
		var file_path = files.upload.path;
		//Node read file using fs module.
		fs.readFile(file_path,'utf8', function(err, data) 
		{
			//Split the csv data by the delimiter (\r\n)
			var array_lines = data.match(/[^\r\n]+/g);
			var json_object = [];
			//Considering thr first row as the csv headers.
			var headers = array_lines[0].split(',');
			//Loop with the remaining data lines.
			for(var i = 1; i < array_lines.length; i++) 
			{
				//Split the row by delimiter (,)
				var data = array_lines[i].split(',');
				var temp_obj = {};
				//Loop with the data columns.
				for(var j = 0; j < data.length; j++) 
				{
					//If the current column data have a correct header the map the same on the data object with header as the key.
					if(typeof headers[j] != 'undefined')
					temp_obj[headers[j].trim()] = data[j].trim();
				}
				//Push the row data to the main data object.
				json_object.push(temp_obj);
			}
			//Make the object as a json data.
			JSON.stringify(json_object);
			var data_table_headers = [];
			//Convert the json data to the vue 2 data tabel format.
			for(var j = 0; j < headers.length; j++) 
			{
				data_table_headers.push({"title":headers[j].trim(),"field":headers[j].trim(),"sortable":false});
			}
			//send back the reponse to the xhr request.
			res.json({"data":json_object,"headers":data_table_headers,"status":1});
		});
	});
}